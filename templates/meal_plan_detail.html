{% extends "base.html" %}

{% block title %}Wochenplan {{ meal_plan.week_start_date.strftime('%d.%m.%Y') }} - Meal Planner{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-start mb-4">
            <div>
                <h1>Wochenplan</h1>
                <p class="text-muted">
                    Woche vom {{ meal_plan.week_start_date.strftime('%d.%m.%Y') }} bis 
                    {{ (meal_plan.week_start_date|add_days(6)).strftime('%d.%m.%Y') }}
                </p>
            </div>
            <div class="btn-group" role="group">
                <a href="{{ url_for('shopping_list', plan_id=meal_plan.id) }}" class="btn btn-success">
                    <i data-feather="shopping-cart" class="me-2"></i>
                    Einkaufsliste
                </a>
                <form method="POST" action="{{ url_for('delete_meal_plan', plan_id=meal_plan.id) }}" class="d-inline"
                      onsubmit="return confirm('Wochenplan wirklich löschen?')">
                    <button type="submit" class="btn btn-outline-danger">
                        <i data-feather="trash-2" class="me-2"></i>
                        Löschen
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Step 1: Lunch Days Selection -->
<div id="step1" class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i data-feather="home" class="me-2"></i>
                    Schritt 1: An welchen Tagen isst du Mittags zu Hause?
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-3">Wähle die Tage aus, an denen du zu Hause Mittag isst:</p>
                <div class="d-flex flex-wrap gap-2 mb-3">
                    {% set weekdays = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'] %}
                    {% for day in weekdays %}
                    <button type="button" class="btn btn-outline-primary lunch-day-btn" 
                            data-day="{{ loop.index0 }}" data-day-name="{{ day }}">
                        {{ day }}
                    </button>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-success" onclick="proceedToStep2()">
                    <i data-feather="arrow-right" class="me-2"></i>
                    Weiter zu Schritt 2
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Step 2: Daily Planning -->
<div id="step2" class="row mb-4" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i data-feather="calendar" class="me-2"></i>
                    Schritt 2: Tagesplanung
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-3">Plane deine Mahlzeiten für jeden Tag der Woche:</p>
                
                {% for i in range(7) %}
                {% set day_date = meal_plan.week_start_date|add_days(i) %}
                {% set weekday_names = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'] %}
                
                <div class="day-card mb-3" data-day="{{ i }}">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center" 
                             style="cursor: pointer;" onclick="toggleDay({{ i }})">
                            <div class="d-flex align-items-center">
                                <input type="checkbox" class="form-check-input me-2 day-active-checkbox" 
                                       id="day{{ i }}_active" onchange="toggleDayActive({{ i }})">
                                <h6 class="mb-0">
                                    {{ weekday_names[i] }}, {{ day_date.strftime('%d.%m.%Y') }}
                                </h6>
                            </div>
                            <i data-feather="chevron-down" class="day-chevron" id="chevron{{ i }}"></i>
                        </div>
                        <div class="collapse day-collapse" id="dayCollapse{{ i }}">
                            <div class="card-body">
                                <div class="day-not-home alert alert-secondary" id="dayNotHome{{ i }}" style="display: none;">
                                    <i data-feather="coffee" class="me-2"></i>
                                    An diesem Tag isst du nicht zu Hause.
                                </div>
                                
                                <div class="day-meals" id="dayMeals{{ i }}">
                                    <!-- Breakfast -->
                                    <div class="meal-section mb-4">
                                        <h6 class="mb-3">
                                            <i data-feather="sunrise" class="me-2"></i>
                                            Frühstück
                                        </h6>
                                        <div class="meal-assignment" data-day="{{ i }}" data-meal="breakfast">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <select class="form-select recipe-select" data-day="{{ i }}" data-meal="breakfast">
                                                        <option value="">Rezept wählen...</option>
                                                        {% for recipe in recipes %}
                                                        <option value="{{ recipe.id }}">{{ recipe.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <input type="number" class="form-control portions-input" 
                                                           data-day="{{ i }}" data-meal="breakfast"
                                                           placeholder="Portionen" min="1" max="20" value="2">
                                                </div>
                                                <div class="col-md-3">
                                                    <input type="number" class="form-control meals-count-input" 
                                                           data-day="{{ i }}" data-meal="breakfast"
                                                           placeholder="Für wieviele Mahlzeiten?" min="1" max="10" value="1">
                                                </div>
                                                <div class="col-md-2">
                                                    <button type="button" class="btn btn-outline-success btn-sm add-meal-btn"
                                                            data-day="{{ i }}" data-meal="breakfast" onclick="addMeal(this)">
                                                        <i data-feather="plus"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="planned-meals mt-2" data-day="{{ i }}" data-meal="breakfast"></div>
                                        </div>
                                    </div>

                                    <!-- Lunch (conditionally shown) -->
                                    <div class="meal-section mb-4 lunch-section" id="lunchSection{{ i }}" style="display: none;">
                                        <h6 class="mb-3">
                                            <i data-feather="sun" class="me-2"></i>
                                            Mittagessen
                                        </h6>
                                        <div class="meal-assignment" data-day="{{ i }}" data-meal="lunch">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <select class="form-select recipe-select" data-day="{{ i }}" data-meal="lunch">
                                                        <option value="">Rezept wählen...</option>
                                                        {% for recipe in recipes %}
                                                        <option value="{{ recipe.id }}">{{ recipe.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <input type="number" class="form-control portions-input" 
                                                           data-day="{{ i }}" data-meal="lunch"
                                                           placeholder="Portionen" min="1" max="20" value="2">
                                                </div>
                                                <div class="col-md-3">
                                                    <input type="number" class="form-control meals-count-input" 
                                                           data-day="{{ i }}" data-meal="lunch"
                                                           placeholder="Für wieviele Mahlzeiten?" min="1" max="10" value="1">
                                                </div>
                                                <div class="col-md-2">
                                                    <button type="button" class="btn btn-outline-success btn-sm add-meal-btn"
                                                            data-day="{{ i }}" data-meal="lunch" onclick="addMeal(this)">
                                                        <i data-feather="plus"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="planned-meals mt-2" data-day="{{ i }}" data-meal="lunch"></div>
                                        </div>
                                    </div>

                                    <!-- Dinner -->
                                    <div class="meal-section mb-4">
                                        <h6 class="mb-3">
                                            <i data-feather="moon" class="me-2"></i>
                                            Abendessen
                                        </h6>
                                        <div class="meal-assignment" data-day="{{ i }}" data-meal="dinner">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <select class="form-select recipe-select" data-day="{{ i }}" data-meal="dinner">
                                                        <option value="">Rezept wählen...</option>
                                                        {% for recipe in recipes %}
                                                        <option value="{{ recipe.id }}">{{ recipe.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <input type="number" class="form-control portions-input" 
                                                           data-day="{{ i }}" data-meal="dinner"
                                                           placeholder="Portionen" min="1" max="20" value="2">
                                                </div>
                                                <div class="col-md-3">
                                                    <input type="number" class="form-control meals-count-input" 
                                                           data-day="{{ i }}" data-meal="dinner"
                                                           placeholder="Für wieviele Mahlzeiten?" min="1" max="10" value="1">
                                                </div>
                                                <div class="col-md-2">
                                                    <button type="button" class="btn btn-outline-success btn-sm add-meal-btn"
                                                            data-day="{{ i }}" data-meal="dinner" onclick="addMeal(this)">
                                                        <i data-feather="plus"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="planned-meals mt-2" data-day="{{ i }}" data-meal="dinner"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                <div class="mt-4">
                    <button type="button" class="btn btn-outline-secondary me-2" onclick="backToStep1()">
                        <i data-feather="arrow-left" class="me-2"></i>
                        Zurück zu Schritt 1
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveMealPlan()">
                        <i data-feather="save" class="me-2"></i>
                        Wochenplan speichern
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Summary -->
{% if planned_meals %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i data-feather="coffee" class="me-2"></i>
                    Aktuelle Planung ({{ planned_meals|length }} Mahlzeiten)
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Tag</th>
                                <th>Mahlzeit</th>
                                <th>Rezept</th>
                                <th>Portionen</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for meal in planned_meals %}
                            <tr>
                                <td>{{ meal.date.strftime('%d.%m.%Y') }}</td>
                                <td>
                                    <span class="badge bg-{% if meal.meal_type == 'breakfast' %}warning{% elif meal.meal_type == 'lunch' %}info{% else %}success{% endif %}">
                                        {% if meal.meal_type == 'breakfast' %}Frühstück
                                        {% elif meal.meal_type == 'lunch' %}Mittagessen
                                        {% else %}Abendessen{% endif %}
                                    </span>
                                </td>
                                <td>
                                    <a href="{{ url_for('recipe_detail', recipe_id=meal.recipe_id) }}" 
                                       class="text-decoration-none">
                                        {{ meal.recipe_name }}
                                    </a>
                                </td>
                                <td>{{ meal.servings }}</td>
                                <td>
                                    <form method="POST" 
                                          action="{{ url_for('remove_planned_meal', plan_id=meal_plan.id, meal_index=loop.index0) }}" 
                                          class="d-inline" 
                                          onsubmit="return confirm('Mahlzeit wirklich entfernen?')">
                                        <button type="submit" class="btn btn-outline-danger btn-sm">
                                            <i data-feather="trash-2"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
let lunchDays = new Set();
let weekPlan = {};

// Step 1: Lunch Day Selection
document.querySelectorAll('.lunch-day-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const day = parseInt(this.dataset.day);
        if (lunchDays.has(day)) {
            lunchDays.delete(day);
            this.classList.remove('btn-primary');
            this.classList.add('btn-outline-primary');
        } else {
            lunchDays.add(day);
            this.classList.remove('btn-outline-primary');
            this.classList.add('btn-primary');
        }
    });
});

function proceedToStep2() {
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
    
    // Show/hide lunch sections based on selection
    for (let i = 0; i < 7; i++) {
        const lunchSection = document.getElementById(`lunchSection${i}`);
        if (lunchDays.has(i)) {
            lunchSection.style.display = 'block';
        } else {
            lunchSection.style.display = 'none';
        }
    }
}

function backToStep1() {
    document.getElementById('step2').style.display = 'none';
    document.getElementById('step1').style.display = 'block';
}

// Step 2: Day Management
function toggleDay(dayIndex) {
    const collapse = document.getElementById(`dayCollapse${dayIndex}`);
    const chevron = document.getElementById(`chevron${dayIndex}`);
    const checkbox = document.getElementById(`day${dayIndex}_active`);
    
    if (collapse.classList.contains('show')) {
        collapse.classList.remove('show');
        chevron.setAttribute('data-feather', 'chevron-down');
    } else {
        collapse.classList.add('show');
        chevron.setAttribute('data-feather', 'chevron-up');
    }
    feather.replace();
}

function toggleDayActive(dayIndex) {
    const checkbox = document.getElementById(`day${dayIndex}_active`);
    const notHomeDiv = document.getElementById(`dayNotHome${dayIndex}`);
    const mealsDiv = document.getElementById(`dayMeals${dayIndex}`);
    
    if (checkbox.checked) {
        notHomeDiv.style.display = 'none';
        mealsDiv.style.display = 'block';
    } else {
        notHomeDiv.style.display = 'block';
        mealsDiv.style.display = 'none';
    }
}

// Meal Management
function addMeal(button) {
    const day = parseInt(button.dataset.day);
    const mealType = button.dataset.meal;
    const recipeSelect = document.querySelector(`select[data-day="${day}"][data-meal="${mealType}"]`);
    const portionsInput = document.querySelector(`input.portions-input[data-day="${day}"][data-meal="${mealType}"]`);
    const mealsCountInput = document.querySelector(`input.meals-count-input[data-day="${day}"][data-meal="${mealType}"]`);
    
    const recipeId = recipeSelect.value;
    const recipeName = recipeSelect.selectedOptions[0]?.text;
    const portions = parseInt(portionsInput.value) || 2;
    const mealsCount = parseInt(mealsCountInput.value) || 1;
    
    if (!recipeId) {
        alert('Bitte wähle ein Rezept aus.');
        return;
    }
    
    // Add to visual list
    const plannedMealsDiv = document.querySelector(`.planned-meals[data-day="${day}"][data-meal="${mealType}"]`);
    const mealDiv = document.createElement('div');
    mealDiv.className = 'alert alert-light d-flex justify-content-between align-items-center mb-1';
    mealDiv.innerHTML = `
        <span>
            <strong>${recipeName}</strong> - ${portions} Portionen 
            ${mealsCount > 1 ? `(für ${mealsCount} Mahlzeiten)` : ''}
        </span>
        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeMeal(this)">
            <i data-feather="x"></i>
        </button>
    `;
    mealDiv.dataset.recipeId = recipeId;
    mealDiv.dataset.portions = portions;
    mealDiv.dataset.mealsCount = mealsCount;
    
    plannedMealsDiv.appendChild(mealDiv);
    feather.replace();
    
    // Store in plan
    if (!weekPlan[day]) weekPlan[day] = {};
    if (!weekPlan[day][mealType]) weekPlan[day][mealType] = [];
    
    weekPlan[day][mealType].push({
        recipeId: recipeId,
        recipeName: recipeName,
        portions: portions,
        mealsCount: mealsCount
    });
    
    // Reset inputs
    recipeSelect.value = '';
    portionsInput.value = 2;
    mealsCountInput.value = 1;
}

function removeMeal(button) {
    const mealDiv = button.closest('.alert');
    const plannedMealsDiv = mealDiv.closest('.planned-meals');
    const day = parseInt(plannedMealsDiv.dataset.day);
    const mealType = plannedMealsDiv.dataset.meal;
    const recipeId = mealDiv.dataset.recipeId;
    
    // Remove from plan
    if (weekPlan[day] && weekPlan[day][mealType]) {
        weekPlan[day][mealType] = weekPlan[day][mealType].filter(meal => meal.recipeId !== recipeId);
    }
    
    // Remove from DOM
    mealDiv.remove();
}

// Save meal plan
async function saveMealPlan() {
    const planId = '{{ meal_plan.id }}';
    const weekStartDate = '{{ meal_plan.week_start_date.isoformat() }}';
    
    // Prepare meals for submission
    const meals = [];
    
    for (const [dayIndex, dayPlan] of Object.entries(weekPlan)) {
        const dayDate = new Date(weekStartDate);
        dayDate.setDate(dayDate.getDate() + parseInt(dayIndex));
        
        for (const [mealType, mealList] of Object.entries(dayPlan)) {
            for (const meal of mealList) {
                // For multi-meal recipes, add additional meals for subsequent days
                for (let i = 0; i < meal.mealsCount; i++) {
                    const mealDate = new Date(dayDate);
                    mealDate.setDate(mealDate.getDate() + i);
                    
                    meals.push({
                        recipeId: meal.recipeId,
                        date: mealDate.toISOString().split('T')[0],
                        mealType: mealType,
                        portions: meal.portions,
                        location: 'home',
                        notes: i > 0 ? `Reste vom ${dayDate.toLocaleDateString('de-DE')}` : ''
                    });
                }
            }
        }
    }
    
    // Submit meals
    for (const meal of meals) {
        try {
            const formData = new FormData();
            formData.append('recipe_id', meal.recipeId);
            formData.append('date', meal.date);
            formData.append('meal_type', meal.mealType);
            formData.append('servings', meal.portions);
            formData.append('location', meal.location);
            formData.append('notes', meal.notes);
            
            await fetch(`/meal-plans/${planId}/add-meal`, {
                method: 'POST',
                body: formData
            });
        } catch (error) {
            console.error('Error saving meal:', error);
        }
    }
    
    // Reload page to show results
    window.location.reload();
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    feather.replace();
});
</script>

<style>
.lunch-day-btn {
    min-width: 120px;
}

.day-card .card-header:hover {
    background-color: rgba(var(--bs-primary-rgb), 0.1);
}

.meal-section {
    border-left: 3px solid var(--bs-secondary);
    padding-left: 1rem;
}

.meal-assignment .row {
    align-items: center;
}

.planned-meals .alert {
    padding: 0.5rem;
    margin-bottom: 0.25rem;
}

.day-chevron {
    transition: transform 0.2s ease;
}

.collapse.show + .day-chevron {
    transform: rotate(180deg);
}
</style>
{% endblock %}